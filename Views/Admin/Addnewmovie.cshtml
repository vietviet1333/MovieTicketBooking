
@{
    ViewBag.Title = "Addnewmovie";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}


<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<title>Add New Movie</title>
<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Adjust the opacity here */
        display: none;
        justify-content: center;
        align-items: center;
        /* Ensure the loading overlay stays on top */
    }

    .loader {
        border: 8px solid #f3f3f3; /* Light grey */
        border-top: 8px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
    }




        .loader.active {
            display: block;
        }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    input[type="file"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 16px;
        color: aliceblue;
        background-color: #2A3038;
    }

    textarea {
        resize: vertical;
    }

    input[type="submit"] {
        background-color: #007bff;
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: background-color 0.3s ease;
    }

        input[type="submit"]:hover {
            background-color: #0056b3;
        }

    #imagePreview {
        max-height: 200px;
        display: none;
        margin-top: 20px;
        margin-bottom: 5px;
        border-radius: 5px;
    }
</style>



<div class="container">

    <h1>Add New Movie</h1>
    <form action="Insertmovie" method="POST" enctype="multipart/form-data">
        <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
            <div style="flex-basis: calc(50% - 10px); margin-right: 20px;">
                <label for="title">Movie Name:</label>
                <input type="text" id="moviename" name="moviename" required>

                <label for="director">Director:</label>
                <input type="text" id="director" name="director" required>

                <label for="director">Cast:</label>
                <input type="text" id="cast" name="cast" required>

                <label for="director">Language:</label>
                <input type="text" id="language" name="language" required>

                <label for="release_date">Release Date:</label>
                <input type="date" id="release_date" name="release_date" required>

                <label for="duration">Duration (minutes):</label>
                <input type="number" id="duration" name="duration" min="1" required>


            </div>
            <div style="flex-basis: calc(50% - 10px);">
                <label for="genre">Genre:</label>
                <input type="text" id="genre" name="genre" required>

                <label for="description">Description:</label>
                <textarea id="description" name="description" rows="4" required></textarea>

                <label for="image">Image:</label>
                <input type="file" id="image" name="image" accept="image/*" required onchange="previewImage(event)">

                <img id="imagePreview" src="#" alt="Image Preview">




                <input type="hidden" id="urlimage" name="urlimage" />
            </div>
        </div>

        <button class="btn btn-primary btn-xs" style="margin-left: 15px; margin-bottom: 10px; color: #492173; background-color: #8f56cc; border: none" type="button" onclick="abc()" id="btnsubmit"> <i class="mdi mdi-file-check btn-icon-prepend"></i>Add movie </button>

    </form>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>

</div>


<script>
    function validateForm() {
        var moviename = document.getElementById('moviename').value.trim();
        var director = document.getElementById('director').value.trim();
        var cast = document.getElementById('cast').value.trim();
        var language = document.getElementById('language').value.trim();
        var genre = document.getElementById('genre').value.trim();
        var description = document.getElementById('description').value.trim();
        var duration = document.getElementById('duration').value;
        var releaseDate = document.getElementById('release_date').value;

        if (moviename === "" || director === "" || cast === "" || language === "" || genre === "" || description==="") {
           
            return 0;
        }

        if (new Date(releaseDate) < new Date()) {
           
            return 1;
        }
        if (duration < 10 || duration > 500) {
          
            return 2;
        }

        return 3;
    
       
    }

    // Set minimum release date to today
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
    var yyyy = today.getFullYear();

    today = yyyy + '-' + mm + '-' + dd;
    document.getElementById('release_date').setAttribute('min', today);
</script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAULQ0nHsGhEO9t2EPmZlHlvqKhyExSx_g",
        authDomain: "movieticketbooking-7da83.firebaseapp.com",
        projectId: "movieticketbooking-7da83",
        storageBucket: "movieticketbooking-7da83.appspot.com",
        messagingSenderId: "66263933934",
        appId: "1:66263933934:web:17a4eae96f357a8a1724ff",
        measurementId: "G-G4SKDMJYN5"
    };
    firebase.initializeApp(firebaseConfig);
    let urlPath = "";
    async function uploadImage() {
        const inp = document.querySelector('#image').files[0];
        const urll = document.querySelector('#urlimage');

        const storage = firebase.storage();
        const ref = storage.ref();
        const metadata = {
            contentType: inp.type
        };
        const uuid = generateUUID();

        const name = uuid + inp.name;
        const uploadImage = ref.child(name).put(inp, metadata);

        if (inp != null) {
            await uploadImage.then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {

                    urll.value = url;
                    urlPath = url;
                    console.log(urlPath);

                    return urlPath;
                });
        }

    }


    async function abc() {
        const inp = document.querySelector('#image').files[0];
        var checkform = validateForm();
        if (inp != null && checkform == 3) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            await uploadImage();

            document.getElementById('loadingOverlay').style.display = 'none';


            $.ajax({
                url: '/Admin/Insertmovie',
                type: "Post",
                //contentType: "application/json",
                data: {
                    namemovi: $("#moviename").val(),
                    directo: $("#director").val(),
                    languag: $("#language").val(),
                    cas: $("#cast").val(),
                    release_dat: $("#release_date").val(),
                    duratio: $("#duration").val(),
                    genr: $("#genre").val(),
                    descriptio: $("#description").val(),
                    urlimag: $("#urlimage").val(),
                },
                success: (response) => {
                    if (response == "True") {
                        swal({
                            title: "Add movie success",
                            text: "success",
                            timer: 2000,
                            buttons: false,

                        }).then(() => {
                            window.location.replace("https://localhost:44351/Admin/Listmovie");
                        })
                    } else {
                        swal({
                            title: "Add movie fail",
                            text: "Try again",
                            icon: "error",
                            timer: 2000,
                            buttons: false,

                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                    swal({
                        title: "Add movie fail",
                        text: "Try again",
                        icon: "error",
                        timer: 2000,
                        buttons: false,

                    });
                }
            });
        }

        else
            if (checkform == 0) {

                swal({
                    title: "Please fill all feild",
                    text: "Try again",
                    icon: "error",
                    timer: 2000,
                    buttons: false,

                });

            }

            else if (checkform == 1) {

                swal({
                    title: "release date starts today",
                    text: "Try again",
                    icon: "error",
                    timer: 2000,
                    buttons: false,

                });

            }
            else if (checkform == 2) {

                swal({
                    title: "duration from 10 minutes to 500 minutes ",
                    text: "Try again",
                    icon: "error",
                    timer: 2000,
                    buttons: false,

                });

            }
    }
</script>
<script>
    function previewImage(event) {
        var input = event.target;
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function () {
                var imagePreview = document.getElementById('imagePreview');
                imagePreview.src = '';
                imagePreview.src = reader.result;
                imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(event.target.files[0]);
        } else {
            imagePreview.src = '';
            imagePreview.style.display = 'none';
        }
    }

</script>



